<config namespace="page">
  <queries>
    <query name="parents-elements">
      <![CDATA[with h_elements (parent_id, element_id, element_type, element_code, element_title, element_ref, livello)
 as
 (select parent_id, element_id, element_type, element_code, element_title, element_ref, 0 as livello
    from vw_elements_h 
     where element_id = {@field='element_id'}
   union all select e.parent_id, e.element_id, e.element_type, e.element_code, e.element_title, e.element_ref, livello - 1
    from vw_elements_h e
    inner join h_elements he on he.parent_id = e.element_id and he.element_id <> he.parent_id)
 select he.parent_id, he.element_id, he.element_type, he.element_code, he.element_title, he.element_ref, he.livello
  from h_elements he 
  order by he.livello]]>
    </query>
    <query name="childs-elements">
      <![CDATA[with h_elements (parent_id, element_id, element_type, element_code, element_title, element_ref, livello)
 as
 (select parent_id, element_id, element_type, element_code, element_title, element_ref, 0 as livello
    from vw_elements_h 
     where element_id = {@field='element_id'}
   union all select e.parent_id, e.element_id, e.element_type, e.element_code, e.element_title, e.element_ref, livello + 1
    from vw_elements_h e
    inner join h_elements he on he.element_id = e.parent_id)
 select he.parent_id, he.element_id, he.element_type, he.element_code, he.element_title, he.element_ref, he.livello
  from h_elements he order by he.livello]]>
    </query>
    <query name="open-element">
      <![CDATA[select t.*
 from (select 0 as element_level, null as element_parent_id, ec.element_content_id, e.element_id, e.parent_id, e.element_code, e.element_title, e.element_ref, e.element_type 
   , (case when e.child_id is not null then e.element_content_id else null end) as child_content_id, e.child_id, e.child_text, e.child_value, e.child_notes, e.child_code, e.child_style, e.child_ref
   , (select top 1 1 from elements_contents where child_content_type = 'element' and e.child_id is null and element_id = e.element_id) as has_childs_elements
   , (select top 1 element_id from elements_contents where child_content_type = 'element' and e.child_id is null and child_id = e.element_id) as back_element_id
   , null as hide_element
  from vw_elements e 
  join elements_contents ec on ec.child_id = e.element_id and ec.child_content_type = 'element'
  where e.element_id {@field='filter_element'}
 union select 1 as element_level, ec.element_id as element_parent_id, ec.element_content_id, e.element_id, e.parent_id, e.element_code, e.element_title, e.element_ref, e.element_type 
   , (case when e.child_id is not null then e.element_content_id else null end) as child_content_id, e.child_id, e.child_text, e.child_value, e.child_notes, e.child_code, e.child_style, e.child_ref
   , (select top 1 1 from elements_contents where child_content_type = 'element' and e.child_id is null and element_id = e.element_id) as has_childs_elements
   , null as back_element_id, null as hide_element
  from vw_elements e 
  join elements_contents ec on ec.element_id {@field='filter_element'} and ec.child_id = e.element_id and ec.child_content_type = 'element'
 union select 2 as element_level, ec2.element_id as element_parent_id, ec2.element_content_id, e.element_id, e.parent_id, e.element_code, e.element_title, e.element_ref, e.element_type 
   , (case when e.child_id is not null then e.element_content_id else null end) as child_content_id, e.child_id, e.child_text, e.child_value, e.child_notes, e.child_code, e.child_style, e.child_ref
   , (select top 1 1 from elements_contents where child_content_type = 'element' and e.child_id is null and element_id = e.element_id) as has_childs_elements
   , null as back_element_id, null as hide_element
  from vw_elements e 
  join elements_contents ec on ec.element_id {@field='filter_element'} and ec.child_content_type = 'element'
  join elements_contents ec2 on ec2.element_id = ec.child_id and ec2.child_id = e.element_id and ec2.child_content_type = 'element'
 union select 3 as element_level, ec3.element_id as element_parent_id, ec3.element_content_id, e.element_id, e.parent_id, e.element_code, e.element_title, e.element_ref, e.element_type 
   , (case when e.child_id is not null then e.element_content_id else null end) as child_content_id, e.child_id, e.child_text, e.child_value, e.child_notes, e.child_code, e.child_style, e.child_ref
   , (select top 1 1 from elements_contents where child_content_type = 'element' and e.child_id is null and element_id = e.element_id) as has_childs_elements
   , null as back_element_id, null as hide_element
  from vw_elements e 
  join elements_contents ec on ec.element_id {@field='filter_element'} and ec.child_content_type = 'element'
  join elements_contents ec2 on ec2.element_id = ec.child_id and ec2.child_content_type = 'element'
  join elements_contents ec3 on ec3.element_id = ec2.child_id and ec3.child_id = e.element_id and ec3.child_content_type = 'element'
 union select 4 as element_level, ec4.element_id as element_parent_id, ec4.element_content_id, e.element_id, e.parent_id, e.element_code, e.element_title, e.element_ref, e.element_type 
   , (case when e.child_id is not null then e.element_content_id else null end) as child_content_id, e.child_id, e.child_text, e.child_value, e.child_notes, e.child_code, e.child_style, e.child_ref
   , null as has_childs_elements, null as back_element_id, 1 as hide_element
  from vw_elements e 
  join elements_contents ec on ec.element_id {@field='filter_element'} and ec.child_content_type = 'element'
  join elements_contents ec2 on ec2.element_id = ec.child_id and ec2.child_content_type = 'element'
  join elements_contents ec3 on ec3.element_id = ec2.child_id and ec3.child_content_type = 'element'
  join elements_contents ec4 on ec4.element_id = ec3.child_id and ec4.child_id = e.element_id and ec4.child_content_type = 'element'
  where e.child_id is null
  ) t
 order by t.element_level, t.child_id, t.element_id ]]>
    </query>
  </queries>
</config>

