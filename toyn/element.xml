<config namespace="page">
  <queries>
    <query name="elements-attributes">
      <![CDATA[select a.element_type, a.attribute_id
  , a.attribute_code, a.attribute_type, a.content_txt_xml
 from vw_attributes a
 order by a.element_type, a.attribute_code]]>
    </query>
    <query name="open-roots-element">
      <![CDATA[select h.parent_id, h.elements_contents_id, h.livello, h.element_id, h.element_type, h.element_title
  , (select top 1 1 from elements_contents where element_id = h.element_id) as has_childs
  , (select top 1 1 from elements_contents ec join elements e on e.element_id = ec.child_element_id and e.element_type = 'element' where ec.element_id = h.element_id) as has_child_elements
  , h.[order]
  , a.attribute_code, a.attribute_type, a.content_txt_xml, a.val_datetime, a.val_integer, a.val_link, a.val_real, a.val_text, a.val_varchar
 from vw_elements_h h
 left join vw_elements_attrs a on a.element_id = h.element_id 
 where {@field='filter_deleted'} and h.ref_element_id = -1 and {@field='filter_level'}
 order by h.livello, h.[order], h.element_id]]>
    </query>
    <query name="open-element">
      <![CDATA[select t.*
from (
select h.parent_id, h.elements_contents_id, 0 as livello, h.element_id, h.element_type, h.element_title
  , null as has_childs, null as has_child_elements, h.[order]
  , a.attribute_code, a.attribute_type, a.content_txt_xml, a.val_datetime, a.val_integer, a.val_link, a.val_real, a.val_text, a.val_varchar
 from vw_elements_p h
 left join vw_elements_attrs a on a.element_id = h.element_id 
 where isnull(h.deleted, 0) = 0 and h.element_id = {@field='id_element'} {@field='filter_only_childs'}
union select h.parent_id, h.elements_contents_id, h.livello + 1 as livello, h.element_id, h.element_type, h.element_title
  , (select top 1 1 from elements_contents where element_id = h.element_id) as has_childs
  , (select top 1 1 from elements_contents ec join elements e on e.element_id = ec.child_element_id and e.element_type = 'element'
      where ec.element_id = h.element_id) as has_child_elements, h.[order]
  , a.attribute_code, a.attribute_type, a.content_txt_xml, a.val_datetime, a.val_integer, a.val_link, a.val_real, a.val_text, a.val_varchar
 from vw_elements_h h
 left join vw_elements_attrs a on a.element_id = h.element_id 
 where {@field='filter_deleted'} and h.ref_element_id = {@field='id_element'} and {@field='filter_level'} ) t
 order by t.livello, t.[order], t.element_id]]>
    </query>
    <query name="exists-element">
      <![CDATA[select top 1 1 from elements e where isnull(e.deleted, 0) = 0 and e.element_id = {@field='id_element'}]]>
    </query>
    <query name="deleted-element">
      <![CDATA[select top 1 1 from elements e where isnull(e.deleted, 0) = 1 and e.element_type = '{@field='type_element'}' and e.element_id = {@field='id_element'}]]>
    </query>
    <query name="has-childs">
      <![CDATA[select e.element_id
        , (select top 1 1 from elements_contents where element_id = e.element_id) as has_childs
        , (select top 1 1 from elements_contents ec join elements e on e.element_id = ec.child_element_id and e.element_type = 'element'
            where ec.element_id = e.element_id) as has_child_elements
      from [elements] e where e.element_id = {@field='id_element'}
      ]]>
    </query>
  </queries>
</config>

