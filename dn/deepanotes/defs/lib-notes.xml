<config>
  <queries>
    <query name="folders">
      <![CDATA[select ft.tp, ft.synch_folder_id, ft.folder_id, ft.parent_id, ft.title
       , ft.des, ft.http_path, ft.lvl, dbo.folder_path(ft.folder_id) as folder_path
       , (select top 1 1 from dn_tasks where folder_id = ft.folder_id) as is_task
      from dbo.fnc_dn_folders({@field='folder_id'}, {@field='synch_folder_id'}) ft
      order by ft.synch_folder_id, ft.lvl, ft.title]]>
    </query>

    <query name="files">
      <![CDATA[select f.synch_folder_id, f.file_id, f.folder_id, f.file_name, f.dt_ins
       from dn_files f
       where exists (select top 1 1 from dbo.fnc_dn_folders({@field='folder_id'}, {@field='synch_folder_id'}) ft 
	      where ft.synch_folder_id = f.synch_folder_id 
          and isnull(ft.folder_id, 0) = isnull(f.folder_id, 0))]]>
    </query>

    <query name="file-path">
      <![CDATA[select f.folder_id, replace((select local_path from synch_folders where synch_folder_id = f.synch_folder_id) 
        + isnull(dbo.folder_path(f.folder_id), '\') + f.file_name , '/', '\') as file_path
       from dn_files f where f.file_id = {@field='file_id'}]]>
    </query>

    <query name="tasks">
      <![CDATA[select t3.*
      , tst.stato, tst.[order] as stato_order, isnull(tst.class, 'light') as stato_class, isnull(tst.title_plurale, '') as stato_title_plurale, isnull(tst.title_singolare, '') as stato_title_singolare
      , tp.priorita, tp.[order] as priorita_order, isnull(tp.class, 'light') as priorita_class, isnull(tp.title_plurale, '') as priorita_title_plurale, isnull(tp.title_singolare, '') as priorita_title_singolare
      , tt.tipo, tt.[order] as tipo_order, isnull(tt.class, 'light') as tipo_class, isnull(tt.title_plurale, '') as tipo_title_plurale, isnull(tt.title_singolare, '') as tipo_title_singolare
      , ts.stima, ts.[days] as stima_days, isnull(ts.class, 'light') as stima_class, isnull(ts.title_plurale, '') as stima_title_plurale, isnull(ts.title_singolare, '') as stima_title_singolare
      , (select top 1 1 from dn_tasks_notes where task_id = t3.task_id) as task_notes
      , (select top 1 1 from vw_task_allegati f2 where f2.folder_id = t3.folder_id and t3.file_id is null) as task_files
  from (select t2.*, datediff(day, t2.dt_ref, getdate()) as diff_days
    from (select t.task_id, t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id
	   , t.file_id, t.title, t.[user], t.stato, t.priorita, t.tipo, t.stima, t.dt_ins, t.dt_upd
     , (case when t.dt_ins > t.dt_upd then t.dt_ins else t.dt_upd end) as dt_ref
	  from dn_tasks t
	  left join dn_files f on f.file_id = t.file_id
    where ({@field='task_id'} is null or ({@field='task_id'} is not null and t.task_id = {@field='task_id'})) ) t2
    where exists (select top 1 1 from dbo.fnc_dn_folders({@field='folder_id'}, {@field='synch_folder_id'}) ft 
	    where {@field='filter_sf'} ft.synch_folder_id = t2.synch_folder_id 
       and isnull(ft.folder_id, 0) = isnull(t2.folder_id, 0))) t3
   left join dn_task_stato tst on tst.stato = t3.stato
   left join dn_task_priorita tp on tp.priorita = t3.priorita
   left join dn_task_tipo tt on tt.tipo = t3.tipo
   left join dn_task_stima ts on ts.stima = t3.stima
   where 1 = 1 {@field='filters'}]]>
    </query>
  
    <query name="set-task-state">
      <![CDATA[update dn_tasks set stato = {@txtqry='stato'} where task_id = {@field='task_id'}]]>
    </query>

    <query name="set-task-user">
      <![CDATA[update dn_tasks set [user] = {@txtqry='user'} where task_id = {@field='task_id'}]]>
    </query>

    <query name="set-task-priorita">
      <![CDATA[update dn_tasks set priorita = {@txtqry='priorita'} where task_id = {@field='task_id'}]]>
    </query>

    <query name="set-task-stima">
      <![CDATA[update dn_tasks set stima = {@txtqry='stima'} where task_id = {@field='task_id'}]]>
    </query>

    <query name="set-task-tipo">
      <![CDATA[update dn_tasks set tipo = {@txtqry='tipo'} where task_id = {@field='task_id'}]]>
    </query>
    
    <query name="set-task-title">
      <![CDATA[update dn_tasks set title = {@txtqry='title'} where task_id = {@field='task_id'}]]>
    </query>

    <query name="del-task">
      <![CDATA[delete from dn_tasks where task_id = {@field='task_id'}]]>
    </query>

    <query name="task-paths">
      <![CDATA[select t2.task_id, t2.title, t2.folder_id, t2.file_id
  , t2.rel_path, t2.task_name
  , (case when t2.folder_id is not null then t2.folder_path else t2.file_path end) as folder_path
  , (select top 1 t.item as free_txt from dbo.split(t2.task_name, '.') t
    join dn_task_free_labels fl on fl.stato is not null and fl.free_txt = t.item) as free_state
  , (select top 1 t.item as free_txt from dbo.split(t2.task_name, '.') t
    join dn_task_free_labels fl on fl.priorita is not null and fl.free_txt = t.item) as free_priorita
  , (select top 1 t.item as free_txt from dbo.split(t2.task_name, '.') t
    join dn_task_free_labels fl on fl.stima is not null and fl.free_txt = t.item) as free_stima
  , (select top 1 t.item as free_txt from dbo.split(t2.task_name, '.') t
    join dn_task_free_labels fl on fl.tipo is not null and fl.free_txt = t.item) as free_tipo
  , (select top 1 t.item as free_txt from dbo.split(t2.task_name, '.') t
    join users fl on fl.nome = t.item) as free_assegna
 from (select t.task_id, t.title
   , t.folder_id, sf.local_path + isnull(replace(dbo.folder_path(fo.parent_id), '/', '\'), '') as folder_path
   , t.file_id, sf.local_path + isnull(replace(dbo.folder_path(f.folder_id), '/', '\'), '') as file_path
   , isnull(f.file_name, fo.folder_name) as task_name
   , sf.title + isnull(isnull(dbo.folder_path(f.folder_id), dbo.folder_path(fo.parent_id)), '') as rel_path
  from dn_tasks t
  left join synch_folders sf on sf.synch_folder_id = t.synch_folder_id
  left join dn_files f on f.file_id = t.file_id
  left join dn_folders fo on fo.folder_id = t.folder_id 
  where t.task_id = {@field='task_id'}) t2]]>
    </query>

    <query name="ins-task">
      <![CDATA[insert into dn_tasks (synch_folder_id, folder_id, title, [user], stato, dt_upd, readed, priorita, tipo, stima)
 select synch_folder_id, folder_id, {@txtqry='title'}, {@txtqry='user'}, {@txtqry='stato'}, getdate(), 1, {@txtqry='priorita'}, {@txtqry='tipo'}, {@txtqry='stima'}
  from dn_folders where folder_id = {@field='folder_id'}]]>
    </query>
  
    <query name="get-task-notes">
      <![CDATA[select task_notes from dn_tasks_notes 
       where task_id = {@field='task_id'}]]>
    </query>

    <query name="get-task-allegati">
      <![CDATA[select a.file_id, a.file_name, a.extension, a.http_path
      from vw_task_allegati a
      where a.task_id = {@field='task_id'}]]>
    </query>

    <query name="info-task-notes">
      <![CDATA[select t.task_id, t.title, t.folder_id
  , sf.local_path + replace(dbo.folder_path(t.folder_id), '/', '\') as folder_path
  , t.file_id, ft.type_content, ft.open_comment, ft.close_comment
  , sf.local_path + replace(dbo.folder_path(f.folder_id) + f.file_name, '/', '\') as file_path
  , tn.file_id as file_id_notes
  , sf.local_path + replace(dbo.folder_path(fn.folder_id) + fn.file_name, '/', '\') as file_path_notes
 from dn_tasks t
 left join synch_folders sf on sf.synch_folder_id = t.synch_folder_id
 left join dn_files f on f.file_id = t.file_id
 left join dn_files_types ft on ft.extension = f.extension
 left join dn_tasks_notes tn on tn.task_id = t.task_id
 left join dn_files fn on fn.file_id = tn.file_id
 where t.task_id = {@field='task_id'}]]>
    </query>
    <query name="init-notes">
      <![CDATA[delete from dn_tasks_notes where task_id = {@field='task_id'};
      insert into dn_tasks_notes (task_id, task_notes)
            values ({@field='task_id'}, @content);
      update dn_tasks set dt_upd = getdate() where task_id = {@field='task_id'};]]>
    </query>
    <query name="upd-notes">
      <![CDATA[update dn_tasks_notes set task_notes = @content
      where task_id = {@field='task_id'};
      update dn_tasks set dt_upd = getdate() where task_id = {@field='task_id'};]]>
    </query>
  </queries>
</config>

