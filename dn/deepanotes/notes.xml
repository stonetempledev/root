<config>
  <html-blocks>
    <!-- menu -->
    <html-block name="item-events">
      <![CDATA[ onmouseover='show_menu(this)' onmouseout='hide_menu(this)']]>
    </html-block>
    <html-block name="item-display">
      <![CDATA[style='display:none;']]>
    </html-block>
    <html-block name="item-menu">
      <![CDATA[<div class="dropdown no-arrow float-right" title='modifica cartella...'>
        <a tp='menu-item' class="dropdown-toggle mr-2" {@html-block='item-display'} href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
          aria-expanded="false"><i class="fas fa-ellipsis-h text-muted"></i></a>
        <div class="dropdown-menu dropdown-menu-right shadow">
          <h4 class="dropdown-header" style='color: blue; background-color: whitesmoke;'>CARTELLA</h4>
            <div class="dropdown-item"><span onclick="add_folder({@field='id'}, '{@field='tp'}')" style='cursor:pointer;'><i class="fas fa-plus-circle text-info"></i> aggiungi sotto-cartella</span></div>
            <div class="dropdown-item"><span onclick="cut_element({@field='id'}, '{@field='tp'}')" style='cursor:pointer;'><i class="fas fa-cut text-primary"></i> taglia la cartella</span></div>
            <div class="dropdown-item"><span onclick="paste_elements({@field='id'}, '{@field='tp'}')" style='cursor:pointer;'><i class="fas fa-paste text-success"></i> incolla</span></div>
            <div class="dropdown-item"><span onclick="ren_folder('{@field='title'}', {@field='id'}, '{@field='tp'}')" style='cursor:pointer;'><i class="fas fa-edit text-warning"></i> rinomina cartella</span></div>
            <div class="dropdown-item"><span onclick="del_folder({@field='id'}, '{@field='tp'}')" style='cursor:pointer;'><i class="fas fa-trash-alt text-danger"></i> cancella la cartella</span></div>
          </div>
        </div>]]>
    </html-block>
    <html-block name="item-synch-folder">
      <![CDATA[<li tp-item='{@field='tp'}' item-id='{@field='id'}' class='voce primo' {@html-block='item-events'}>
        {@cond_val='url_open_home','open_home'}<a class='h5' href="{@field='url_synch_folder'}">{@field='title'}</a>{@html-block='item-menu'}{@field='block-attivita'}</li>{@field='childs'}]]>
      <cond name="open_home">
        <![CDATA[<a class='fas fa-home mr-2' href="{@field='url_open_home'}"></a>]]>
      </cond>
    </html-block>
    <html-block name="item-secondo">
      <![CDATA[<li tp-item='{@field='tp'}' item-id='{@field='id'}' class='voce secondo {@field='class_cut'}' {@html-block='item-events'}><a class='h6' href="{@field='url_folder'}">{@field='title'}</a>{@field='block-attivita'}{@html-block='item-menu'}</li>{@field='childs'}]]>
    </html-block>
    <html-block name="item-terzo">
      <![CDATA[<li tp-item='{@field='tp'}' item-id='{@field='id'}' class='voce terzo {@field='class_cut'}' {@html-block='item-events'}><a href="{@field='url_folder'}">{@field='title'}</a>{@field='block-attivita'}{@html-block='item-menu'}</li>{@field='childs'}]]>
    </html-block>
    <html-block name="item-quarto">
      <![CDATA[<li tp-item='{@field='tp'}' item-id='{@field='id'}' class='voce quarto {@field='class_cut'}' {@html-block='item-events'}><a href="{@field='url_folder'}">{@field='title'}</a>{@field='block-attivita'}{@cond_val='url_open_folder','open_folder'}{@html-block='item-menu'}</li>]]>
      <cond name="open_folder">
        <![CDATA[<small><a class='fas fa-chevron-circle-right ml-2' style='opacity:0.2;' title='apri la cartella' href="{@field='url_open_folder'}"></a></small>]]>
      </cond>
    </html-block>
    <html-block name="spin-attivita">
      <![CDATA[<a style='opacity: .7;' class="badge badge-pill badge-{@field='class_spin'} ml-2" title="{@field='title'}" href="{@field='url_open_tasks'}">{@field='c_attivita'}</a>]]>
    </html-block>
    <html-block name="spin-attivita-synch">
      <![CDATA[<a style='opacity: .7;' class="badge badge-pill badge-{@field='class_spin'} ml-2" title="{@field='title'}" href="{@field='url_open_tasks'}">{@field='c_attivita'}</a>]]>
    </html-block>
    <!-- attivita -->
    <html-block name="title-attivita">
      <![CDATA[
      <div class="btn-group w-100 mt-3">
        <button type="button" class="btn btn-primary w-100"><h3>{@field='filter-title'}</h3></button>
        <button type="button" class="btn btn-primary dropdown-toggle px-3" data-toggle="dropdown" aria-haspopup="true"
          aria-expanded="false">
          <span class="sr-only">Toggle Dropdown</span>
        </button>
        <div class="dropdown-menu">{@field='html-filters'}</div>
      </div>      
      <h4 class='ml-2'><small>{@field='filter-des'}</small></h4>
      <h5 class='ml-2 mt-4'><small>{@field='conteggio'}</small></h5>
      <hr class='mb-5 mt-5'/>]]>
    </html-block>
    <html-block name="title-attivita-folder">
      <![CDATA[<h1 tp='name_folder' class='h1-responsive bg-primary text-white text-uppercase mb-0'>{@field='title-folder'}</h1>
      {@cond_val='path-folder','path_folder'}

      <div class="btn-group btn-group-sm w-100 mt-3">
        <button type="button" class="btn btn-light w-100 m-0">{@field='filter-title'}</button>
        <button type="button" class="btn btn-light dropdown-toggle px-3 m-0" data-toggle="dropdown" aria-haspopup="true"
          aria-expanded="false">
          <span class="sr-only">Toggle Dropdown</span>
        </button>
        <div class="dropdown-menu">{@field='html-filters'}</div>
      </div
      <h5 class='mb-3'><small>{@field='conteggio'}</small></h5>
      
      <div class='mb-5 mt-4'>
       <p class="note note-primary"><strong>Attività:</strong>
         <a class='text-primary' style='white-space: nowrap;' href="javascript:add_attivita('da_fare')"><i class="fas fa-plus-circle"></i> aggiungi attività da fare</a>
         <a class='text-success' style='white-space: nowrap;' href="javascript:add_attivita('fatto')"><i class="fas fa-plus-circle"></i> aggiungi attività fatta</a>
         <a class='text-warning' style='white-space: nowrap;' href="javascript:add_attivita('in_corso')"><i class="fas fa-plus-circle"></i> aggiungi attività in corso</a></p>
       <p class="note note-light"><strong>Cartelle:</strong>
         <a class='text-info' style='white-space: nowrap;' href="javascript:add_folder()"><i class="fas fa-plus-circle"></i> aggiungi sotto-cartella</a>
         <a class='text-primary' style='white-space: nowrap;' href="javascript:cut_element()"><i class="fas fa-cut"></i> taglia la cartella</a>
         <a class='text-success' style='white-space: nowrap;' href="javascript:paste_elements()"><i class="fas fa-paste"></i> incolla</a>
         <a class='text-warning' style='white-space: nowrap;' href="javascript:ren_folder()"><i class="fas fa-edit"></i> rinomina cartella</a>
         <a class='text-danger' style='white-space: nowrap;' href="javascript:del_folder()"><i class="fas fa-trash-alt"></i> cancella la cartella</a></p>
      </div>]]>
      <cond name="path_folder">
        <![CDATA[<div class='badge badge-info d-block text-left'>//{@field='path-folder'}</div>]]>
      </cond>
    </html-block>
    <html-block name="open-title-sub-attivita">
      <![CDATA[<blockquote class="blockquote bq-{@field='cls'} mb-5"><p class="bq-title text-uppercase">{@field='count'} ATTIVITÀ {@field='title'}</p><p>]]>
    </html-block>
    <html-block name="close-title-sub-attivita">
      <![CDATA[</p></blockquote>]]>
    </html-block>
    <html-block name="task-error">
      <![CDATA[<div task-id='{@field='task_id'}'>
        <div class='badge badge-danger mb-3 d-block text-left text-wrap'>
        <h3>{@field='error'}</h3>
        <hr/><h5>{@field='source'}</h5>
        <hr/><h5>{@field='stack'}</h5></div></div>]]>
    </html-block>
    <html-block name="task">
      <![CDATA[<div task-id='{@field='task_id'}' class='mb-3 {@field='classes'}' task-assegna="{@field='val-assegna'}" task-priorita='{@field='val-priorita'}' task-stima='{@field='val-stima'}' task-tipo='{@field='val-tipo'}'>        
        <!-- title + stato attività -->
        <div class='badge badge-{@field='cls'} d-block text-left text-wrap'>
          <div><span class='h4' tp-val='title' contenteditable='true' onfocus='title_task_focus(this)' onblur='title_task_blur(this)'>{@field='title'}</span>
          
            <div class="dropdown no-arrow float-right ml-2 mt-1">
              <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false"><i class="fas fa-ellipsis-v text-muted"></i></a>
              <div class="dropdown-menu dropdown-menu-right shadow">
                <h4 class="dropdown-header mb-2" style='color: blue; background-color: whitesmoke;'>ATTIVITÀ</h4>
                <div class="dropdown-item mb-2 mt-2" style='cursor:pointer;'><span onclick='modify_task({@field='task_id'})'>
                  <i class="fas fa-pen text-info"></i> aggiorna attività</span></div>
                <div class="dropdown-item mb-2 mt-2" style='cursor:pointer;'><span onclick="del_task({@field='task_id'})">
                  <i class="fas fa-trash-alt text-danger"></i> elimina attività</span></div>
                <div class="dropdown-item mb-2 mt-2" style='cursor:pointer;'><span onclick="cut_element({@field='task_id'}, 'task')">
                  <i class="fas fa-cut text-warning"></i> taglia attività</span></div>
              </div>
            </div>        

            <div class="dropdown no-arrow mr-1 mt-1 float-right">
              <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown" 
                aria-haspopup="true" aria-expanded="false">
                <h4 class='d-inline'><span class='badge badge-pill badge-{@field='cls'}' style='cursor:pointer;'>{@field='stato'}</span></h4></a>
              <div class="dropdown-menu dropdown-menu-right shadow">
                <h4 class="dropdown-header" style='color: blue; background-color: whitesmoke;'>STATO ATTIVITÀ</h4>
                {@field='menu-states'}
              </div>
            </div>
                        
            <h6 class='d-inline float-right mt-2 mr-3'><span class='text-right'>{@field='priorita'}{@field='stima'}{@field='tipo'}</span></h6>
            <h6 class='d-inline float-right mt-2 mr-3' title="clicca per visualizzare o inserire delle note" onclick='open_notes({@field='task_id'})'>
              <span tp-item='btn-notes' class='badge badge-pill badge-info' style='cursor:pointer;'>{@field='title_notes'}</span></h6>

           </div>
           <span class='text-nowrap font-weight-light'>//{@field='path'}</span>
           <!-- notes -->
           <div tp-item='section-notes' class='mt-2' style='display:none;'>
             <span class='text-dark font-weight-light'>note particolari</span>
             <textarea tp-item='txt-notes' style='width:100%;border:0pt;' spellcheck="false" wrap='on' class='mt-2 text-muted' rows=7
              onfocus='focus_task_notes({@field='task_id'})' onblur='blur_task_notes({@field='task_id'})'></textarea>
           </div>
           <!-- allegati -->
           <div tp-item='section-allegati' class='mt-2' style='display:none;'>
           </div>
           <!-- footer -->
           <hr class='m-1'/><h5>{@field='assegnata'}<small class='float-right'>{@field='data'}</small></h5></div></div>]]>
    </html-block>
    <html-block name="task-allegati">
      <![CDATA[<span class='text-dark font-weight-light mb-2' style='display:block;'>allegati</span>{@field='html-allegati'}]]>
    </html-block>
    <html-block name="task-allegato">
      <![CDATA[<h5 class='d-inline mr-3' style='opacity: 0.7;' title="scarica allegato..."><a href="{@field='http-path'}" target='blank' class='badge badge-pill badge-light'>{@field='file-name'}</a></h5>]]>
    </html-block>
    <html-block name="task-state">
      <![CDATA[<span class='mr-1 badge badge-pill badge-{@field='cls'}'>{@field='txt'}</span>]]>
    </html-block>
    <html-block name="menu-state">
      <![CDATA[<a class="dropdown-item" href="javascript:task_state({@field='task_id'}, '{@field='assign_stato'}')"><h5>{@field='title'}</h5></a>]]>
    </html-block>
  </html-blocks>

  <queries>
    <query name="menu-states">
      <![CDATA[select title_singolare, stato from dn_task_stato order by [order]]]>
    </query>
    <query name="task-assegna">
      <![CDATA[select t.title, t.[value]
      from (select '' as title, '' as [value]
       union select nome as title, nome as [value] from users
       ) t order by 2]]>
    </query>
    <query name="task-priorita">
      <![CDATA[select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, priorita as [value], [order] from dn_task_priorita
      ) t order by t.[order]]]>
    </query>
    <query name="task-tipi">
      <![CDATA[select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [order]
       union select title_singolare as title, tipo as [value], [order] from dn_task_tipo
       ) t order by t.[order]]]>
    </query>
    <query name="task-stime">
      <![CDATA[select t.title, t.[value]
      from (select '' as title, '' as [value], -1 as [days]
       union select title_singolare as title, stima as [value], [days] from dn_task_stima 
       ) t order by t.[days]]]>
    </query>
    <query name="folder-local-path">
      <![CDATA[select sf.local_path + replace(dbo.folder_path(f.folder_id), '/', '\') as local_path, sf.synch_folder_id, f.folder_name as name
 from dn_folders f 
 join synch_folders sf on sf.synch_folder_id = f.synch_folder_id
 where f.folder_id = {@field='folder_id'}]]>
    </query>
    <query name="synch-folder-local-path">
      <![CDATA[select local_path, synch_folder_id, title as name 
        from synch_folders where synch_folder_id = {@field='synch_folder_id'}]]>
    </query>
    <query name="filters-tasks">
      <![CDATA[select task_filter_id, filter_title, filter_notes, filter_def, filter_class
 from dn_tasks_filters order by filter_order]]>
    </query>
    <query name="ids-childs-folders">
      <![CDATA[select folder_id from dn_folders where parent_id is null and synch_folder_id = {@field='synch_folder_id'}]]>
    </query>
    <query name="get-synch-folder-id">
      <![CDATA[select top 1 synch_folder_id from dn_folders where folder_id = {@field='folder_id'}]]>
    </query>
    <query name="get-file-task">
      <![CDATA[select top 1 t.synch_folder_id, isnull(t.folder_id, f.folder_id) as folder_id, t.file_id, f.file_name
       from dn_tasks t
       left join dn_files f on f.file_id = t.file_id
       where t.task_id = {@field='task_id'}]]>
    </query>
    <query name="set-folder-new-parent">
      <![CDATA[update df set df.synch_folder_id = {@field='synch_folder_id'}, df.dt_upd = getdate()
       from dn_tasks df
       where df.synch_folder_id <> {@field='synch_folder_id'} 
        and df.folder_id in (select folder_id from dbo.fnc_dn_folders ({@field='folder_id'}, null) where tp = 'folder');

      update df set df.synch_folder_id = {@field='synch_folder_id'}, df.dt_upd = getdate()
       from dn_tasks df
       join dn_files f on f.file_id = df.file_id
       where df.synch_folder_id <> {@field='synch_folder_id'} 
        and f.folder_id in (select folder_id from dbo.fnc_dn_folders ({@field='folder_id'}, null) where tp = 'folder');
      
      update df set df.synch_folder_id = {@field='synch_folder_id'}, df.dt_upd = getdate()
       from dn_files df
       where df.synch_folder_id <> {@field='synch_folder_id'} 
        and folder_id in (select folder_id from dbo.fnc_dn_folders ({@field='folder_id'}, null) where tp = 'folder');
       
      update dn_folders set synch_folder_id = {@field='synch_folder_id'}, dt_upd = getdate()
       where synch_folder_id <> {@field='synch_folder_id'} 
        and folder_id in (select folder_id from dbo.fnc_dn_folders ({@field='folder_id'}, null) where tp = 'folder' and lvl > 1);
         
      update dn_folders set synch_folder_id = {@field='synch_folder_id'}, parent_id = {@field='parent_id'}, dt_upd = getdate()
        where folder_id = {@field='folder_id'};]]>
    </query>
    <query name="set-file-new-parent">
      <![CDATA[update df set df.synch_folder_id = {@field='synch_folder_id'}, df.folder_id = {@field='parent_id'}, dt_upd = getdate()
       from dn_files df where df.file_id = {@field='file_id'};
       
       update dn_tasks set synch_folder_id = {@field='synch_folder_id'}, dt_upd = getdate()
       where file_id = {@field='file_id'} and synch_folder_id <> {@field='synch_folder_id'};
       ]]>
    </query>
    <query name="add-folder">
      <![CDATA[insert into dn_folders (synch_folder_id, parent_id, folder_name, readed)
 values ({@field='synch_folder_id'}, {@field='parent_id'}, left({@txtqry='folder_name'}, 150), 1)]]>
    </query>
    <query name="ren-folder">
      <![CDATA[update dn_folders set folder_name = left({@txtqry='folder_name'}, 150)
        where folder_id = {@field='folder_id'}]]>
    </query>
    <query name="ren-synch-folder">
      <![CDATA[update synch_folders set title = left({@txtqry='title'}, 50)
        where synch_folder_id = {@field='synch_folder_id'}]]>
    </query>
    <query name="del-folder">
      <![CDATA[delete f from dn_files f
 join (select ft.*
	 from dbo.fnc_dn_folders({@field='folder_id'}, {@field='synch_folder_id'}) ft
	 where ft.lvl > 0) ff on ff.folder_id = f.folder_id and ff.synch_folder_id = f.synch_folder_id;

 delete f from dn_folders f
  join (select ft.*
	 from dbo.fnc_dn_folders({@field='folder_id'}, {@field='synch_folder_id'}) ft
	 where ft.lvl > 0) ff on ff.folder_id = f.folder_id and ff.synch_folder_id = f.synch_folder_id;
   
 delete dn from dn_tasks dn
  where folder_id is not null and not exists (select top 1 1 from dn_folders where folder_id = dn.folder_id);

 delete dn from dn_tasks dn
  where file_id is not null and not exists (select top 1 1 from dn_files where file_id = dn.file_id);
  
 delete dn from dn_tasks_contents dn
  where file_id is not null and not exists (select top 1 1 from dn_files where file_id = dn.file_id);
  
 delete dn from dn_tasks_notes dn
  where file_id is not null and not exists (select top 1 1 from dn_files where file_id = dn.file_id);]]>
    </query>
    <query name="clean-synch">
      <![CDATA[delete from dn_files where synch_folder_id = {@field='synch_folder_id'};

 delete from dn_folders where synch_folder_id = {@field='synch_folder_id'};
 
 delete dn from dn_tasks dn
  where folder_id is not null and not exists (select top 1 1 from dn_folders where folder_id = dn.folder_id);

 delete dn from dn_tasks dn
  where file_id is not null and not exists (select top 1 1 from dn_files where file_id = dn.file_id);
  
 delete dn from dn_tasks_contents dn
  where file_id is not null and not exists (select top 1 1 from dn_files where file_id = dn.file_id);
  
 delete dn from dn_tasks_notes dn
  where file_id is not null and not exists (select top 1 1 from dn_files where file_id = dn.file_id);]]>
    </query>
  </queries>
</config>
