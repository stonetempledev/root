using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Drawing;
using AutocompleteMenuNS;

namespace molinafy {
  public class rtb_nodes : RichTextBox {

    internal class ACItem : AutocompleteItem {
      public ACItem (string text, string tt_title = "", string tt_text = "")
        : base(text) {
        if (tt_title != "" && tt_text != "") {
          ToolTipTitle = tt_title;
          ToolTipText = tt_text;
        }
      }

      public override CompareResult Compare (string fragmentText) {
        return CompareResult.Visible;
      }
    }

    public AutocompleteMenu _ac_path = null;
    protected List<node> _nodes_path = null;

    public rtb_nodes () {
      _ac_path = new AutocompleteMenu();
      _ac_path.AutoPopup = false;
      _ac_path.CaptureFocus = true;
      _ac_path.Font = new System.Drawing.Font("Microsoft Sans Serif", 9F);
      _ac_path.ImageList = null;
      _ac_path.Items = new string[0];
      _ac_path.TargetControlWrapper = null;
      _ac_path.SetAutocompleteMenu(this, null);
      _ac_path.Selecting += new EventHandler<SelectingEventArgs>(_ac_path_Selecting);
      _nodes_path = new List<node>();
    }

    void _ac_path_Selecting (object sender, SelectingEventArgs e) {
      //add_event("am_Selecting");
      e.Cancel = true;

      this.SelectionStart += this.SelectionLength;
      this.SelectionLength = 0;
      this.SelectedText = e.Item.Text;

      //rtb.AppendText(e.Item.Text);
      _ac_path.Close();
    }

    protected override void OnKeyPress (KeyPressEventArgs e) {
      base.OnKeyPress(e);

      if (e.KeyChar == '/') {
        e.Handled = true;
        this.AppendText("\\");
      }
    }

    protected override void OnKeyUp (KeyEventArgs e) {
      base.OnKeyUp(e);

      if (_ac_path.Visible || e.KeyCode == Keys.Escape) return;

      try {
        //// autocomplete nodes
        //if (Char.IsLetterOrDigit((char)e.KeyValue)) {
        //  string last_3 = this.TextLength >= 3 ? this.Text.Substring(this.SelectionStart - 3, 3) : "";
        //  if (last_3.Length > 0) {
        //    if (last_3 == "pop") {
        //      //add_event("pop");
        //      int st = this.SelectionStart;
        //      this.Select(this.SelectionStart - 3, 3);
        //      this.SelectionColor = Color.Blue;
        //      this.SelectionStart = st;
        //      this.SelectionLength = 0;
        //      this.SelectionColor = Color.White;
        //    } else if (last_3 == "pip") {
        //      //add_event("pip");
        //      if (!_ac_path.Visible) {
        //        //add_event("show autocomplete");
        //        _ac_path.SetAutocompleteItems(new List<AutocompleteItem>() { new ACItem("azz", "Osti:", "la mannaia\ndomar\nasdo\nmar")
        //        , new ACItem("zzi")
        //        , new ACItem("zzzzo")
        //        , new ACItem("sti")});
        //        _ac_path.Show(this, true);
        //      }
        //    }
        //  }
        //}
      } catch (Exception ex) {
        //add_event(ex.Message, Color.Red); 
      }
    }

  }
}

